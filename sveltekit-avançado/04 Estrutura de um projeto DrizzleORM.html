<!DOCTYPE html>

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://unpkg.com/highlightjs-svelte/dist/svelte.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlightjs-line-numbers.js/2.9.0/highlightjs-line-numbers.min.js"></script>
    <script defer>hljs.configure({ languages: ["javascript"] }); hljs.highlightAll(); hljs.initLineNumbersOnLoad();</script>

    <!-- https://github.com/arronhunt/highlightjs-copy -->
    <link rel="stylesheet" href="https://unpkg.com/highlightjs-copy/dist/highlightjs-copy.min.css" />
    <script src="https://unpkg.com/highlightjs-copy/dist/highlightjs-copy.min.js"></script>
    <script defer>hljs.addPlugin(new CopyButtonPlugin());</script>

    <!-- https://github.com/TRSasasusu/highlightjs-highlight-lines.js -->
    <!-- <script src="https://cdn.jsdelivr.net/gh/TRSasasusu/highlightjs-highlight-lines.js@1.2.0/highlightjs-highlight-lines.min.js"></script> -->
    <!-- <script defer>hljs.highlightLinesAll([[], [], [], [{ start: 3, end: 3, color: 'lightgreen' }]]);</script> -->

    <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous" onload="renderMathInElement(document.body,{delimiters:[{left: '$$', right: '$$', display: true},{left: '$', right: '$', display: false}]});"></script> -->

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/pedrosiqueira/custom-style/custom.min.css">
    <script src="https://cdn.jsdelivr.net/gh/pedrosiqueira/custom-style/custom.min.js"></script>
</head>

<h1>Estrutura de um projeto DrizzleORM</h1>

<p>Quando criamos um projeto SvelteKit com Drizzle, conforme a se√ß√£o <a href="03 Criando um projeto SvelteKit avan√ßado.html#criacao-projeto">Criando um projeto do zero</a>, ele vem estruturado da seguinte maneira:</p>
<pre><code>üì¶ pasta-raiz
‚î£‚îÅ‚îÅ üìÇ drizzle
‚î£‚îÅ‚îÅ üìÇ src
‚îÉ   ‚îó‚îÅ‚îÅ üìÇ lib
‚îÉ       ‚îó‚îÅ‚îÅ üìÇ server
‚îÉ           ‚îó‚îÅ‚îÅ üìÇ db
‚îÉ               ‚î£‚îÅ‚îÅ üìÑ index.js
‚îÉ               ‚îó‚îÅ‚îÅ üìÑ schema.js
‚î£‚îÅ‚îÅ üìÑ .env
‚î£‚îÅ‚îÅ üìÑ drizzle.config.js
‚îó‚îÅ‚îÅ üìÑ package.json</code></pre>

<p>Cinco importantes arquivos s√£o criados:</p>

<h2 id="o-arquivo-package-json-">O arquivo <code>package.json</code></h2>
<p>Al√©m dos pacotes mencionados no tutorial <a target="_blank" href="../sveltekit/0A%20Criando%20um%20projeto%20SvelteKit.html#o-arquivo-package-json">Criando um projeto SvelteKit</a>, um projeto com Drizzle inclui:</p>
<ul>
    <li><code>dependencies</code> (Depend√™ncias usadas no ambiente de produ√ß√£o):
        <ul>
            <li><code>drizzle-orm</code>: Biblioteca de mapeamento objeto-relacional (ORM) usado para interagir com bancos de dados SQL. Ele fornece uma API baseada em SQL, permitindo escrever consultas seguras e eficientes.</li>
            <li><code>@libsql/client</code>: Um <i>driver</i> para JavaScript que permite conectar-se a bancos de dados SQLite.</li>
            <!-- <li>Pacotes do LuciaAuth:
                <ul>
                    <li><code>@oslojs/crypto</code>: Biblioteca de fun√ß√µes para <i>hashing</i> e <i>criptografia</i>, usadas para gerar senhas e verificar senhas seguras.</li>
                    <li><code>@oslojs/encoding</code>: Biblioteca de codifica√ß√£o e decodifica√ß√£o de dados, incluindo <i>Base64</i> e <i>hexadecimal</i>, usadas para manipula√ß√£o segura de tokens, senhas e dados sens√≠veis.</li>
                </ul>
            </li> -->
        </ul>
    </li>
    <li><code>devDependencies</code> (Depend√™ncias usadas apenas no ambiente de desenvolvimento):
        <ul>
            <li><code>drizzle-kit</code>: Ferramenta CLI para gerenciamento de migra√ß√µes no DrizzleORM. Permite gerar e aplicar migra√ß√µes no banco de dados com comandos simples, al√©m de introspec√ß√£o de esquemas.</li>
        </ul>
    </li>
</ul>

<p>Al√©m dos <a target="_blank" href="../sveltekit/0A%20Criando%20um%20projeto%20SvelteKit.html#principais-comandos-sveltekit">comandos SvelteKit</a> definidos no arquivo <code>package.json</code>, tamb√©m est√£o inclusos os seguintes comandos do DrizzleKit:</p>
<ul>
    <li>
        <p><code>pnpm run db:push</code>:</p>
        <ul>
            <li>Aplica o esquema do Drizzle diretamente no banco <strong>sem gerar um arquivo de migra√ß√£o</strong>.</li>
            <li><strong>Uso comum</strong>: Atualizar o banco rapidamente sem versionamento de mudan√ßas.</li>
            <li><strong>Cuidado:</strong> Pode sobrescrever altera√ß√µes existentes no banco irreversivelmente!</li>
        </ul>
    </li>
    <li>
        <p><code>pnpm run db:migrate</code>:</p>
        <ul>
            <li><strong>Aplica migra√ß√µes pendentes</strong> ao banco de dados.</li>
            <li>Antes de rodar esse comando, √© necess√°rio gerar as migra√ß√µes (<code>pnpm exec drizzle-kit generate</code>).</li>
            <li><strong>Uso comum</strong>: Manter um <strong>hist√≥rico seguro</strong> das mudan√ßas na estrutura do banco.</li>
        </ul>
    </li>
    <li>
        <p><code>pnpm run db:studio</code>:</p>
        <ul>
            <li>Inicia um servidor web local com <strong>interface visual interativa</strong> para explorar e gerenciar o banco de dados.</li>
            <li>Permite visualizar tabelas, executar consultas e depurar dados <strong>diretamente pelo navegador</strong>.</li>
            <li><strong>Uso comum</strong>: Inspecionar ou modificar dados manualmente</strong> sem usar programa√ß√£o ou SQL diretamente.</li>
        </ul>
    </li>
</ul>

<p>Se precisar modificar o banco de dados, use <code>pnpm run db:migrate</code> para versionar mudan√ßas ou <code>pnpm run db:push</code> para sincronizar diretamente. Caso queira inspecionar os dados, o <code>pnpm run db:studio</code> pode ser √∫til.</p>

<h2>O arquivo <code>.env</code></h2>
<p>O arquivo <code>.env</code> (dotenv) √© um arquivo de texto usado para armazenar vari√°veis de ambiente em projetos de software. Ele permite manter informa√ß√µes sens√≠veis e configura√ß√µes de ambiente separadas do c√≥digo-fonte, facilitando a configura√ß√£o do projeto e aumentando a seguran√ßa. Suas principais caracter√≠sticas incluem:</p>

<ul>
    <li><strong>Armazena credenciais e informa√ß√µes sens√≠veis</strong>
        <ul>
            <li>Exemplos: chaves de API, tokens de autentica√ß√£o, configura√ß√µes de banco de dados.</li>
        </ul>
    </li>
    <li><strong>Facilita a configura√ß√£o de diferentes ambientes</strong>
        <ul>
            <li>Permite definir valores espec√≠ficos para ambientes de Desenvolvimento (<code>.env.dev</code>), Teste (<code>.env.test</code>) e Produ√ß√£o (<code>.env.prod</code>).</li>
        </ul>
    </li>
    <li><strong>Evita "c√≥digo chumbado" (hard-coded)<foot-note href="#hard-coded"></foot-note></strong>
        <ul>
            <li>Altera√ß√µes de configura√ß√£o podem ser feitas sem modificar o c√≥digo-fonte, reduzindo o risco de erros e a necessidade de recompila√ß√£o.</li>
        </ul>
    </li>
</ul>

<div class="info"><em>Observa√ß√£o:</em> O termo <i>hard-coded</i> (c√≥digo chumbado) se refere a valores ou configura√ß√µes inseridos diretamente no c√≥digo-fonte de um programa, em vez de serem armazenados em arquivos externos, vari√°veis de ambiente ou banco de dados. Isso torna o c√≥digo menos flex√≠vel e mais dif√≠cil de manter.</div>

<p>Como o arquivo <code>.env</code> pode conter informa√ß√µes sens√≠veis e configura√ß√µes de ambiente espec√≠ficas, ele <strong>n√£o deve ser versionado</strong>. Para evitar vazamentos, deve ser inclu√≠do no arquivo <code>.gitignore</code>.</p>

<p>No caso de projetos com Drizzle e SQLite, crie na pasta raiz o arquivo <code ctc>.env</code>:</p>
<pre><code class="js">DATABASE_URL=file:meubanco.db</code></pre>
<p>A vari√°vel de ambiente <code>DATABASE_URL</code> define o caminho do banco de dados SQLite que ser√° utilizado pelo Drizzle ORM. O valor <code>file:meubanco.db</code> indica que o SQLite armazenar√° os dados no arquivo <code>meubanco.db</code>, localizado na pasta raiz.</p>
<p>Diferente de bancos como PostgreSQL ou MySQL, que utilizam um servidor, o SQLite √© um banco de dados local e baseado em arquivos. O Drizzle abre o arquivo <code>meubanco.db</code> onde s√£o armazenadas as tabelas e os dados. Se <code>meubanco.db</code> n√£o existir, o SQLite cria automaticamente esse arquivo com um novo banco de dados.</p>

<h2>O arquivo <code>schema.js</code></h2>
<p>No Drizzle ORM, o arquivo <code>schema.js</code> define a estrutura do banco de dados. Em projetos SvelteKit, ele geralmente fica localizado em <code>src/lib/server/db/</code>. Esse arquivo descreve as tabelas, colunas, tipos de dados e restri√ß√µes aplicadas ao SQLite.</p>
<p>Inicialmente, ele pode conter algumas tabelas de exemplo, mas depois excluiremos essas tabelas e definiremos nosso pr√≥prio esquema de dados.</p>

<h2 id="o-arquivo-index-js-">O arquivo <code>index.js</code></h2>
<p>O arquivo <code>index.js</code>, localizado em <code>src/lib/server/db/</code>, √© respons√°vel por configurar a conex√£o com o banco de dados no Drizzle ORM. Ele inicializa o cliente de banco de dados (quem se conecta ao banco) e exporta um objeto que representa o banco (<code>db</code>), que ser√° usado em todo o aplicativo para acessar o banco.</p>
<h3 id="explica-o-do-c-digo">Explica√ß√£o do c√≥digo</h3>
<pre><code class="lang-javascript"><span class="hljs-keyword">import</span> { drizzle } <span class="hljs-keyword">from</span> <span class="hljs-string">'drizzle-orm/libsql'</span>;
<span class="hljs-keyword">import</span> { createClient } <span class="hljs-keyword">from</span> <span class="hljs-string">'@libsql/client'</span>;
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> schema <span class="hljs-keyword">from</span> <span class="hljs-string">'./schema'</span>;
<span class="hljs-keyword">import</span> { env } <span class="hljs-keyword">from</span> <span class="hljs-string">'$env/dynamic/private'</span>;
</code></pre>
<ul>
    <li><strong><code>drizzle-orm/libsql</code></strong>: Importa a fun√ß√£o <code>drizzle</code>, usada para criar a conex√£o com o banco de dados.</li>
    <li><strong><code>@libsql/client</code></strong>: Importa <code>createClient</code>, que cria o cliente de conex√£o com o banco, atrav√©s do driver LibSQL.</li>
    <li><strong><code>./schema</code></strong>: Importa o esquema do banco de dados definido no arquivo <code>schema.js</code>. </li>
    <li><strong><code>$env/dynamic/private</code></strong>: Importa <a target="_blank" href="https://svelte.dev/docs/kit/$env-dynamic-private">vari√°veis de ambiente privadas</a> do SvelteKit. </li>
</ul>
<hr>
<pre><code class="lang-javascript"><span class="hljs-keyword">if</span> (!env.DATABASE_URL) throw <span class="hljs-keyword">new</span> <span class="hljs-literal">Error</span>(<span class="hljs-symbol">'DATABASE_URL</span> <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> set');
</code></pre>
<ul>
    <li>Verifica se a vari√°vel de ambiente <code>DATABASE_URL</code> est√° definida. Se n√£o estiver, lan√ßa um erro para evitar que a aplica√ß√£o tente rodar sem uma conex√£o configurada. </li>
</ul>
<hr>
<pre><code class="lang-javascript"><span class="hljs-attribute">const client</span> = createClient({ url: env.DATABASE_URL });
</code></pre>
<ul>
    <li>Cria um cliente do banco de dados usando a URL definida na vari√°vel de ambiente <code>DATABASE_URL</code>. </li>
</ul>
<hr>
<pre><code class="lang-javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> db = drizzle(client, { schema });
</code></pre>
<ul>
    <li>Cria e exporta o objeto de ORM, associando o cliente do banco e o esquema (<code>schema</code>).</li>
    <li>Esse objeto <code>db</code> ser√° utilizada no c√≥digo para interagir com o banco de dados, permitindo consultas, inser√ß√µes, atualiza√ß√µes e exclus√µes sem precisar escrever SQL diretamente.</li>
</ul>

<h2>O arquivo <code>drizzle.config.js</code></h2>
<p>O arquivo <code>drizzle.config.js</code> configura o funcionamento do Drizzle Kit. O Drizzle Kit √© um kit de programas CLI (Command Line Interface) que gerencia migra√ß√µes do banco de dados.</p>
<p>Basicamente, para gerenciar migra√ß√µes em um banco de dados SQLite com o Drizzle Kit, as principais propriedades de configura√ß√£o s√£o:</p>
<ul>
    <li><code>schema</code>: Caminho do arquivo que define as tabelas e colunas do banco (<code>schema.js</code>).</li>
    <li><code>dbCredentials</code>: Define as propriedades de conex√£o do banco de dados (no caso de SQLite, precisamos apenas da URL, contida na vari√°vel de ambiente <code>DATABASE_URL</code>).</li>
</ul>
<p>Al√©m dessas propriedades obrigat√≥rias para se conectar a um banco de dados SQLite, o arquivo de configura√ß√£o pode ter <a target="_blank" href="https://orm.drizzle.team/docs/drizzle-config-file">v√°rias outras propriedades</a>, dentre elas:</p>
<table class="custom">
    <thead>
        <tr>
            <th>Propriedade</th>
            <th>Descri√ß√£o</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><code>verbose</code></td>
            <td>Se <code>true</code>, exibe mais detalhes ao rodar comandos no terminal.</td>
        </tr>
        <tr>
            <td><code>strict</code></td>
            <td>Se <code>true</code>, ativa verifica√ß√µes mais rigorosas no esquema do banco.</td>
        </tr>
        <tr>
            <td><code>dialect</code></td>
            <td>Define o tipo de banco de dados usado (<code>sqlite</code>, no caso).</td>
        </tr>
    </tbody>
</table>

<h2 id="-a-pasta-drizzle-">A Pasta <code>drizzle</code></h2>
<p>A pasta <code>drizzle</code> √© onde ficam armazenados os <strong>arquivos de migra√ß√£o</strong> gerados pelo Drizzle Kit. Ela mant√©m um hist√≥rico das altera√ß√µes feitas no esquema do banco de dados, garantindo que as mudan√ßas possam ser aplicadas, revertidas ou rastreadas. Em resumo, cada migra√ß√£o representa uma &quot;vers√£o&quot; do banco, permitindo evolu√≠-lo sem perder dados.</p>
<p>Depois de rodar um comando de gera√ß√£o de migra√ß√£o como...</p>
<pre><code class="sh">pnpm exec drizzle-kit generate</code></pre>
<p>... A pasta <code>drizzle/</code> ser√° criada (caso ainda n√£o exista) e conter√° arquivos como:</p>
<ul>
    <li><code>0000_initial_migration.sql</code>: Primeira migra√ß√£o, criando tabelas do schema.</li>
    <li><code>0001_add_column_users.sql</code>: Exemplo de uma migra√ß√£o que adiciona uma coluna</li>
    <li><code>0002_create_orders_table.sql</code>: Exemplo de uma migra√ß√£o para criar uma tabela </li>
</ul>
<p>Esses arquivos cont√™m comandos <strong>SQL</strong> que o Drizzle usar√° para modificar o banco.</p>

<p>Para aplicar as migra√ß√µes geradas, basta rodar o comando: </p>
<pre><code class="lang-bash">pnpm run db:migrate</code></pre>
<p>Isso executar√° os arquivos <code>.sql</code> na sequ√™ncia correta, garantindo que todas as mudan√ßas sejam refletidas no banco de dados.</p>