<!DOCTYPE html>

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script src="https://unpkg.com/highlightjs-svelte/dist/svelte.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlightjs-line-numbers.js/2.9.0/highlightjs-line-numbers.min.js"></script>
  <script defer>hljs.configure({ languages: ["svelte"] }); hljs.highlightAll(); hljs.initLineNumbersOnLoad();</script>

  <!-- https://github.com/arronhunt/highlightjs-copy -->
  <link rel="stylesheet" href="https://unpkg.com/highlightjs-copy/dist/highlightjs-copy.min.css" />
  <script src="https://unpkg.com/highlightjs-copy/dist/highlightjs-copy.min.js"></script>
  <script defer>hljs.addPlugin(new CopyButtonPlugin());</script>

  <!-- https://github.com/TRSasasusu/highlightjs-highlight-lines.js -->
  <!-- <script src="https://cdn.jsdelivr.net/gh/TRSasasusu/highlightjs-highlight-lines.js@1.2.0/highlightjs-highlight-lines.min.js"></script>
  <script defer>hljs.highlightLinesAll([[], [], [{ start: 2, end: 2, color: 'lightblue' }]]);</script> -->

  <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous" onload="renderMathInElement(document.body,{delimiters:[{left: '$$', right: '$$', display: true},{left: '$', right: '$', display: false}]});"></script> -->

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/pedrosiqueira/custom-style/custom.min.css">
  <script src="https://cdn.jsdelivr.net/gh/pedrosiqueira/custom-style/custom.min.js"></script>
</head>

<h1>Cookies com SvelteKit</h1>

<h2 id="gerenciamento-estado">Gerenciamento de Estado na Web</h2>
<p>Antes de entrarmos no assunto de cookies, vamos entender primeiramente o contexto em que eles foram inventados e por que s√£o necess√°rios.</p>
<p>A comunica√ß√£o entre sistemas frequentemente se desenrola em v√°rias etapas. Conforme essa comunica√ß√£o avan√ßa, o "estado" da intera√ß√£o muda. Podemos definir o "estado" da comunica√ß√£o como "o conjunto de informa√ß√µes que descreve o contexto atual de uma intera√ß√£o entre cliente e servidor". Em outras palavras: o estado representa a identidade do usu√°rio, suas a√ß√µes pr√©vias, o est√°gio atual da intera√ß√£o ou qualquer outro dado que o servidor precise lembrar entre requisi√ß√µes. Isto posto, um sistema pode ser classificado como stateless ou stateful.</p>

<h3 id="stateless">‚úÖ Stateless (Sem Estado)</h3>
<p>Um sistema <strong>stateless</strong> n√£o ret√©m informa√ß√µes sobre intera√ß√µes anteriores. Cada requisi√ß√£o √© tratada de forma <strong>independente</strong>, como se fosse a <strong>primeira intera√ß√£o</strong> entre o cliente e o servidor.</p>
<p>Exemplo: O protocolo HTTP puro √© stateless. Em cada requisi√ß√£o, o servidor n√£o reconhece o cliente, a menos que a requisi√ß√£o inclua um identificador (token, cookie, etc.).</p>

<h3 id="stateful">üîÅ Stateful (Com Estado)</h3>
<p>Um sistema <strong>stateful</strong> <strong>mant√©m informa√ß√µes</strong> sobre intera√ß√µes passadas. O servidor <strong>lembra do cliente</strong> entre requisi√ß√µes, geralmente armazenando esses dados em uma <strong>sess√£o</strong>.</p>
<p>Exemplo: Ap√≥s o login em um site, o servidor armazena os dados do usu√°rio em uma sess√£o, permitindo que ele permane√ßa autenticado enquanto navega pelas p√°ginas.</p>

<h3 id="comparacao-estado">üìä Compara√ß√£o</h3>
<table border>
  <thead>
    <tr>
      <th>Caracter√≠stica</th>
      <th>Stateless</th>
      <th>Stateful</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Mant√©m estado?</td>
      <td>‚ùå N√£o</td>
      <td>‚úÖ Sim</td>
    </tr>
    <tr>
      <td>Complexidade no servidor</td>
      <td>‚úÖ Baixa</td>
      <td>üî∫ Alta</td>
    </tr>
    <tr>
      <td>Escalabilidade</td>
      <td>‚úÖ Alta (sem estado para gerenciar)</td>
      <td>üîª Menor (estado precisa ser compartilhado entre servidores ou persistido)</td>
    </tr>
    <tr>
      <td>Exemplos</td>
      <td>APIs REST, HTTP puro</td>
      <td>Sites com login, WebSockets</td>
    </tr>
    <tr>
      <td>Requisi√ß√µes independentes?</td>
      <td>‚úÖ Sim</td>
      <td>‚ùå N√£o</td>
    </tr>
    <tr>
      <td>Armazenamento de sess√£o</td>
      <td>‚ùå Cliente envia tudo o que √© necess√°rio</td>
      <td>‚úÖ Servidor armazena dados da sess√£o</td>
    </tr>
  </tbody>
</table>

<hr />

<h2 id="o-que-sao-cookies">üç™ O que s√£o Cookies?</h2>
<p><strong>Cookies</strong> s√£o pequenos arquivos de texto que os navegadores armazenam localmente no dispositivo do usu√°rio a pedido de um servidor web. Eles servem para guardar informa√ß√µes √∫teis entre diferentes requisi√ß√µes HTTP, que, por padr√£o, s√£o <em>stateless</em> (sem estado).</p>
<p>Ou seja, sem cookies (ou outros mecanismos de armazenamento), cada requisi√ß√£o seria tratada como se fosse feita por um visitante completamente novo.</p>

<h3 id="para-que-servem">üß† Para que servem?</h3>
<p>Cookies podem ser usados para diversas finalidades, incluindo:</p>
<ul>
  <li><strong>Autentica√ß√£o</strong>: manter o usu√°rio logado.</li>
  <li><strong>Prefer√™ncias</strong>: tema, idioma, layout do site.</li>
  <li><strong>Carrinho de compras</strong>: persist√™ncia dos itens selecionados.</li>
  <li><strong>An√°lise de dados (Analytics)</strong>: rastrear o comportamento do usu√°rio para fins estat√≠sticos.</li>
  <li><strong>Personaliza√ß√£o</strong>: exibir conte√∫dos personalizados com base no perfil do usu√°rio (marketing).</li>
</ul>

<h3 id="como-funcionam">üõ† Como funcionam?</h3>

<p>O servidor envia um cookie para o navegador usando o cabe√ßalho HTTP <code>Set-Cookie</code>. Exemplo:</p>
<pre><code>Set-Cookie: sessionId=abc123; HttpOnly; Path=/; Max-Age=3600</code></pre>
<p>Esse cookie ser√° armazenado pelo navegador e inclu√≠do automaticamente em cada requisi√ß√£o subsequente ao mesmo dom√≠nio (ou caminho correspondente).</p>
<h3 id="envio-pelo-navegador">2. Envio pelo navegador</h3>
<p>Sempre que o navegador fizer uma nova requisi√ß√£o ao servidor, ele incluir√° todos os cookies v√°lidos no cabe√ßalho <code>Cookie</code>:</p>
<pre><code>Cookie: sessionId=abc123</code></pre>

<h3 id="atributos-cookie">üîê Atributos importantes de um cookie</h3>
<table border>
  <thead>
    <tr>
      <th>Atributo</th>
      <th>Descri√ß√£o</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>Name=Value</code></td>
      <td>Nome e valor do cookie. Obrigat√≥rio.</td>
    </tr>
    <tr>
      <td><code>Path</code></td>
      <td>Define em qual caminho o cookie √© enviado. Ex: <code>/</code>, <code>/admin</code>.</td>
    </tr>
    <tr>
      <td><code>Domain</code></td>
      <td>Restringe o cookie a um subdom√≠nio (ex: <code>.meusite.com</code>).</td>
    </tr>
    <tr>
      <td><code>Expires</code></td>
      <td>Data e hora em que o cookie expira.</td>
    </tr>
    <tr>
      <td><code>Max-Age</code></td>
      <td>Tempo de vida em segundos (prefer√≠vel em vez de <code>Expires</code>).</td>
    </tr>
    <tr>
      <td><code>HttpOnly</code></td>
      <td>Impede o acesso via JavaScript, aumentando a seguran√ßa contra ataques XSS (Cross-Site Scripting).</td>
    </tr>
    <tr>
      <td><code>Secure</code></td>
      <td>Garante que o cookie seja enviado apenas em conex√µes HTTPS (seguras).</td>
    </tr>
    <tr>
      <td><code>SameSite</code></td>
      <td>Controla o envio do cookie em requisi√ß√µes cross-site, protegendo contra ataques CSRF (Cross-Site Request Forgery). Pode ser <code>Strict</code>, <code>Lax</code> ou <code>None</code>.</td>
    </tr>
  </tbody>
</table>

<div class="info">
  <p>Dica: Use as ferramentas de desenvolvedor do seu navegador (geralmente acess√≠veis pelo menu "Mais ferramentas" ou clicando com o bot√£o direito na p√°gina e selecionando "Inspecionar") para visualizar os cookies de qualquer p√°gina web!</p>
</div>

<h3 id="tipos-de-cookies">üí° Tipos de Cookies</h3>
<p>Podemos classificar os cookies com base na sua durabilidade:</p>
<table border>
  <thead>
    <tr>
      <th>Tipo</th>
      <th>Dura√ß√£o</th>
      <th>Uso Comum</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>De Sess√£o</strong></td>
      <td>At√© o fechamento do navegador</td>
      <td>Login tempor√°rio, carrinhos de compras para usu√°rios n√£o registrados, manter prefer√™ncias durante uma sess√£o an√¥nima.</td>
    </tr>
    <tr>
      <td><strong>Persistentes</strong></td>
      <td>At√© a data de expira√ß√£o definida (<code>Max-Age</code> ou <code>Expires</code>)</td>
      <td>Funcionalidade "Lembrar de mim" em logins, prefer√™ncias de tema e idioma, itens salvos no carrinho de compras entre visitas.</td>
    </tr>
  </tbody>
</table>

<p>Tamb√©m podemos classificar os cookies com base no dom√≠nio que os define:</p>

<table border>
  <thead>
    <tr>
      <th>Tipo</th>
      <th>Descri√ß√£o</th>
      <th>Uso Comum</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>Pr√≥prios (First-party)</strong></td>
      <td>Cookies definidos pelo pr√≥prio site que voc√™ est√° visitando.</td>
      <td>Melhorar a experi√™ncia do usu√°rio, coletar dados anal√≠ticos sobre o comportamento do usu√°rio no site, lembrar configura√ß√µes de idioma ou outras prefer√™ncias.</td>
    </tr>
    <tr>
      <td><strong>De Terceiros (Third-party)</strong></td>
      <td>Cookies definidos por um dom√≠nio diferente do site que voc√™ est√° visitando (geralmente por anunciantes, redes sociais ou outros servi√ßos externos).</td>
      <td>Rastreamento do usu√°rio em diferentes sites para fins de publicidade direcionada, exibir an√∫ncios personalizados com base nos seus interesses, integrar funcionalidades de redes sociais (como bot√µes de "curtir" ou "compartilhar").</td>
    </tr>
  </tbody>
</table>

<h3 id="seguranca">‚ö†Ô∏è Boas Pr√°ticas de Seguran√ßa</h3>
<ol>
  <li><strong>HttpOnly</strong>: Protege contra ataques XSS, impedindo que scripts JavaScript acessem o cookie.</li>
  <li><strong>Secure</strong>: Garante que o cookie seja transmitido apenas por conex√µes HTTPS (criptografadas), evitando intercepta√ß√£o por terceiros.</li>
  <li><strong>SameSite</strong>: Controla quando o cookie √© enviado em requisi√ß√µes cross-site, mitigando o risco de ataques CSRF.
    <ul>
      <li><code>Strict</code>: O cookie s√≥ √© enviado em requisi√ß√µes originadas do mesmo site. Oferece a maior prote√ß√£o contra CSRF, mas pode afetar a usabilidade em alguns cen√°rios (ex: links externos).</li>
      <li><code>Lax</code>: Permite o envio do cookie em algumas requisi√ß√µes cross-site "seguras", como ao clicar em links (m√©todo GET). Oferece um bom equil√≠brio entre seguran√ßa e usabilidade.</li>
      <li><code>None</code>: Permite o envio do cookie em todas as requisi√ß√µes cross-site. Requer que o atributo <code>Secure</code> tamb√©m seja definido, garantindo que o cookie seja transmitido apenas por HTTPS.</li>
    </ul>
  </li>
  <li><strong>Cookies n√£o s√£o criptografados por padr√£o</strong>. Se voc√™ precisar armazenar dados sens√≠veis, √© essencial criptograf√°-los antes de armazenar no cookie.</li>
</ol>

<h3>Como os cookies afetam a privacidade?</h3>
<p>Adaptado <a href="https://www.geeksforgeeks.org/understanding-cookies-in-web-browsers/">daqui</a> </p>
<p>Os cookies podem ter efeitos tanto positivos quanto negativos na privacidade:</p>

<p>Positivo: Cookies podem melhorar a experi√™ncia do usu√°rio, lembrando prefer√™ncias e informa√ß√µes de login, tornando os sites mais f√°ceis de usar.</p>

<p>Negativo: Cookies podem levantar preocupa√ß√µes com a privacidade quando s√£o usados para rastreamento e cria√ß√£o de perfis sem o consentimento do usu√°rio. O rastreamento excessivo pode resultar em perda de privacidade online e potencial uso indevido de dados.</p>

<h3 id="alternativas">üì¶ Cookies vs Alternativas</h3>
<p>Al√©m dos cookies, existem outras formas de armazenamento no navegador:</p>
<table border>
  <thead>
    <tr>
      <th>Tecnologia</th>
      <th>Vis√≠vel no JS?</th>
      <th>Expira?</th>
      <th>Envio autom√°tico ao servidor?</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Cookies</td>
      <td>Sim (se n√£o for HttpOnly)</td>
      <td>Sim</td>
      <td>Sim</td>
    </tr>
    <tr>
      <td>localStorage</td>
      <td>Sim</td>
      <td>N√£o</td>
      <td>N√£o</td>
    </tr>
    <tr>
      <td>sessionStorage</td>
      <td>Sim</td>
      <td>Ao fechar a aba</td>
      <td>N√£o</td>
    </tr>
    <tr>
      <td>IndexedDB</td>
      <td>Sim</td>
      <td>N√£o</td>
      <td>N√£o</td>
    </tr>
  </tbody>
</table>
<p>Use cookies quando voc√™ <strong>precisar que o servidor tenha acesso aos dados</strong> em cada requisi√ß√£o. Para outros casos, utilize <code>localStorage</code> ou <code>sessionStorage</code>.</p>

<h3 id="conclus√£o">‚úÖ Conclus√£o</h3>
<p>Cookies s√£o essenciais para adicionar "mem√≥ria" aos aplicativos web. Quando utilizados corretamente, eles permitem autentica√ß√£o, personaliza√ß√£o e muito mais. No entanto, seu uso deve ser feito com cautela, respeitando as boas pr√°ticas de seguran√ßa (como <code>HttpOnly</code>, <code>Secure</code> e <code>SameSite</code>) e a privacidade do usu√°rio.</p>
<hr />

<h2 id="cookies-no-sveltekit">üçÉ Cookies no SvelteKit</h2>

<p>No SvelteKit, a API <code>cookies</code> √© uma forma conveniente de interagir com cookies HTTP tanto no servidor quanto no cliente. Ela simplifica a leitura, grava√ß√£o e remo√ß√£o de cookies, abstraindo a complexidade do cabe√ßalho <code>Set-Cookie</code>. A API <code>cookies</code> est√° dispon√≠vel atrav√©s do objeto <code>event</code> em fun√ß√µes como <code>load</code> e <code>actions</code> em <code>+page.server.js</code>, <code>+layout.server.js</code> ou <code>hooks.server.js</code>.</p>

<div class="info"><strong>Importante:</strong> No Svelte 5, o uso de cookies no cliente √© mais restrito por padr√£o, seguindo as pr√°ticas recomendadas de seguran√ßa e privacidade. O acesso direto aos cookies no cliente deve ser feito com cautela, e geralmente √© prefer√≠vel usar as fun√ß√µes <code>load</code> ou <code>actions</code> para manipular cookies no servidor e passar os dados necess√°rios para o cliente.</div>

<h3>Leitura de Cookies</h3>

<p>Para ler cookies, voc√™ usa o m√©todo <code>cookies.get(name)</code>. Se o cookie n√£o existir, ele retornar√° <code>undefined</code>.</p>

<pre><code class="js">// +page.server.js ou +layout.server.js ou hooks.server.js
export const load = async ({ cookies }) => {
  const theme = cookies.get('theme') || 'light'; // Pega o tema ou usa 'light' como padr√£o
  const userId = cookies.get('userId');

  return {
    theme,
    userId: userId ? parseInt(userId, 10) : null, // Garante que userId seja um n√∫mero (ou null)
  };
};
</code></pre>

<p>No componente Svelte (<code>+page.svelte</code> ou <code>+layout.svelte</code>), voc√™ pode acessar os dados retornados pela fun√ß√£o <code>load</code>:</p>

<pre><code class="svelte">&lt;script&gt;
  let { data } = $props();
  let theme = $derived(data.theme);
  let userId = $derived(data.userId);
&lt;/script&gt;

&lt;p&gt;Tema atual: {theme}&lt;/p&gt;
&lt;p&gt;ID do usu√°rio: {userId ? userId : 'N√£o autenticado'}&lt;/p&gt;

&lt;style&gt;
  :global(body) {
    background-color: {theme == 'dark' ? '#333' : '#fff'};
    color: {theme == 'dark' ? '#fff' : '#000'};
  }
&lt;/style&gt;
</code></pre>

<h3>Escrita de Cookies</h3>

<p>Para definir um cookie, voc√™ usa o m√©todo <code>cookies.set(name, value, options)</code>. As op√ß√µes permitem controlar atributos importantes do cookie.</p>

<pre><code class="js">// +page.server.js
export const actions = {

  setUserId: async ({ cookies }) => {
    cookies.set('userId', '123', {
      path: '/', // Define o caminho para o cookie (dispon√≠vel em todo o site)
      maxAge: 60 * 60 * 24 * 7, // Define a validade do cookie para 7 dias (em segundos)
      httpOnly: true, //  Impede o acesso do lado do cliente (mais seguro para dados sens√≠veis)
      secure: process.env.NODE_ENV === 'production', // Requer HTTPS em produ√ß√£o
      sameSite: 'strict', // Prote√ß√£o contra ataques CSRF
    });
    return { success: true };
  },

  setTheme: async ({ request, cookies }) => {
    const data = await request.formData();
    const theme = data.get('theme');

    if (theme === 'dark' || theme === 'light') {
      cookies.set('theme', theme, {
        path: '/',
        maxAge: 60 * 60 * 24 * 30, // 7 dias
      });
      return { success: true };
    }

    return { success: false, error: 'Invalid theme value' };
  }
};
</code></pre>

<p>E o formul√°rio no seu componente Svelte (<code>+page.svelte</code>):</p>

<pre><code class="svelte">
&lt;script&gt;
  let form = $props();
&lt;/script&gt;

&lt;form method="POST" action="?/setTheme">
  &lt;label&gt;
    Selecione um tema:
    &lt;select name="theme"&gt;
      &lt;option value="light"&gt;Claro&lt;/option&gt;
      &lt;option value="dark"&gt;Escuro&lt;/option&gt;
    &lt;/select&gt;
  &lt;/label&gt;
  &lt;button type="submit"&gt;Salvar Tema&lt;/button&gt;
</form>

{#if form?.success}
  &lt;p style="color: green;"&gt;Tema salvo com sucesso!&lt;/p&gt;
{/if}

{#if form?.error}
  &lt;p style="color: red;"&gt;Erro: {form.error}&lt;/p&gt;
{/if}
</code></pre>

<p><strong>Op√ß√µes Importantes ao Definir Cookies:</strong></p>

<ul>
  <li><strong>path:</strong> O caminho para o qual o cookie √© v√°lido. <code>'/'</code> significa que o cookie √© v√°lido para todo o site.</li>
  <li><strong>maxAge:</strong> A vida √∫til do cookie em segundos. Ap√≥s esse tempo, o cookie √© automaticamente removido pelo navegador. Use <code>expires</code> para definir uma data/hora espec√≠fica de expira√ß√£o.</li>
  <li><strong>expires:</strong> Data de expira√ß√£o do cookie (objeto <code>Date</code>).</li>
  <li><strong>httpOnly:</strong> Se <code>true</code>, o cookie n√£o pode ser acessado via JavaScript do lado do cliente. Isso ajuda a proteger contra ataques XSS (Cross-Site Scripting). <strong>Defina como <code>true</code> sempre que poss√≠vel.</strong></li>
  <li><strong>secure:</strong> Se <code>true</code>, o cookie s√≥ ser√° transmitido atrav√©s de HTTPS. <strong>Sempre defina como <code>true</code> em produ√ß√£o.</strong></li>
  <li><strong>sameSite:</strong> Controla quando o cookie √© enviado com solicita√ß√µes cross-site. Op√ß√µes:
    <ul>
      <li><code>'strict'</code>: O cookie s√≥ √© enviado para o mesmo site que o definiu. Protege fortemente contra CSRF.</li>
      <li><code>'lax'</code>: O cookie √© enviado com navega√ß√µes top-level seguras (GET) para o mesmo site, mas n√£o com solicita√ß√µes cross-site originadas de formul√°rios POST ou JavaScript. √â um bom meio-termo entre seguran√ßa e usabilidade.</li>
      <li><code>'none'</code>: O cookie √© enviado com todas as solicita√ß√µes, tanto same-site quanto cross-site. <strong>Requer <code>secure: true</code>.</strong></li>
    </ul>
  </li>
  <li><strong>domain:</strong> O dom√≠nio para o qual o cookie √© v√°lido (ex: <code>'example.com'</code>). Se n√£o definido, o padr√£o √© o dom√≠nio do site que definiu o cookie.</li>
</ul>

<h3>Remo√ß√£o de Cookies</h3>

<p>Para remover um cookie, voc√™ usa o m√©todo <code>cookies.delete(name, options)</code>. √â importante fornecer as mesmas op√ß√µes <code>path</code> e <code>domain</code> usadas ao definir o cookie, caso contr√°rio, o cookie pode n√£o ser removido.</p>

<pre><code class="js">
// +page.server.js
export const actions = {
  clearUserId: async ({ cookies }) => {
    cookies.delete('userId', { path: '/', httpOnly: true, secure: true, sameSite: 'strict' }); // exemplo com mais op√ß√µes
    return { success: true };
  },
  clearTheme: async ({ cookies }) => {
    cookies.delete('theme', { path: '/' });
    return { success: true };
  }
};
</code></pre>

<p><strong>Importante:</strong> O navegador s√≥ remover√° o cookie se o nome, caminho e dom√≠nio corresponderem exatamente aos valores originais definidos para o cookie. Se voc√™ n√£o especificar o caminho correto, o cookie permanecer√° no navegador.</p>

<h3>Hooks Server (<code>hooks.server.js</code>)</h3>

<p><code>hooks.server.js</code> √© um lugar ideal para lidar com cookies globalmente, como para autentica√ß√£o ou rastreamento de sess√£o. Voc√™ pode interceptar cada solicita√ß√£o e resposta para ler ou definir cookies.</p>

<pre><code class="js">
// hooks.server.js
import { sequence } from '@sveltejs/kit/hooks';

async function handleAuth({ event, resolve }) {
  const userId = event.cookies.get('userId');

  if (userId) {
    event.locals.user = { id: parseInt(userId, 10) }; // Adiciona o usu√°rio ao `event.locals` para acesso em rotas
  }

  const response = await resolve(event);
  return response;
}

export const handle = sequence(handleAuth);
</code></pre>

<p>Agora, em suas rotas (<code>+page.server.js</code> ou <code>+layout.server.js</code>), voc√™ pode acessar <code>event.locals.user</code>:</p>

<pre><code class="js">
// +page.server.js ou +layout.server.js
export const load = async ({ locals }) => {
  return {
    user: locals.user,
  };
};
</code></pre>

<h3>Boas Pr√°ticas e Seguran√ßa Refor√ßada</h3>
<ul>
  <li><strong>Use <code>httpOnly: true</code>:</strong> Sempre que poss√≠vel, defina <code>httpOnly: true</code> para impedir o acesso do JavaScript do lado do cliente. Isso mitiga ataques XSS.</li>
  <li><strong>Use <code>secure: true</code> em Produ√ß√£o:</strong> Garanta que os cookies sejam transmitidos apenas por HTTPS em ambientes de produ√ß√£o.</li>
  <li><strong>Configure <code>sameSite</code>:</strong> Escolha o valor <code>sameSite</code> apropriado (<code>'strict'</code>, <code>'lax'</code> ou <code>'none'</code>) com base nos requisitos de teu aplicativo e considera√ß√µes de seguran√ßa CSRF. <code>'strict'</code> √© geralmente a op√ß√£o mais segura, mas pode afetar a usabilidade em alguns casos.</li>
  <li><strong>Valide e Sanitiza√ß√£o:</strong> Sempre valide e sanitize os dados que voc√™ est√° armazenando em cookies, especialmente se eles vierem de entrada do usu√°rio.</li>
  <li><strong>Limite o Tamanho dos Cookies:</strong> Navegadores imp√µem limites no tamanho dos cookies (geralmente 4KB por cookie e um limite total por dom√≠nio). Evite armazenar grandes quantidades de dados em cookies.</li>
  <li><strong>Considere o Tempo de Vida:</strong> Defina um tempo de vida razo√°vel para seus cookies usando <code>maxAge</code> ou <code>expires</code>. Evite cookies que persistem indefinidamente, a menos que seja estritamente necess√°rio.</li>
  <li><strong>Cuidado com Dados Sens√≠veis:</strong> Evite armazenar informa√ß√µes altamente sens√≠veis (como senhas ou n√∫meros de cart√£o de cr√©dito) em cookies. Se precisar armazenar dados sens√≠veis, criptografe-os antes de defini-los como cookies. Considere usar tokens JWT ou mecanismos de sess√£o mais seguros para gerenciar a autentica√ß√£o e autoriza√ß√£o.</li>
  <li><strong>Use as Ferramentas de Desenvolvedor:</strong> Utilize as ferramentas de desenvolvedor do seu navegador para inspecionar cookies, verificar seus atributos e solucionar problemas.</li>
</ul>

<h2 id="exercicios">üéØ Exerc√≠cios de Fixa√ß√£o</h2>
<ol>
  <li>Explique a diferen√ßa entre cookies de sess√£o e cookies persistentes.</li>
  <li>O que significa o atributo <code>httpOnly</code> de um cookie e por que √© importante us√°-lo?</li>
  <li>Descreva o que s√£o ataques CSRF (Cross-Site Request Forgery) e como o atributo <code>sameSite</code> pode ajudar a preveni-los.</li>
  <li>Em que cen√°rios voc√™ usaria cookies no SvelteKit em vez de outras formas de gerenciamento de estado, como <code>stores</code>?</li>
  <li>Explique como o SvelteKit lida com cookies no lado do servidor e como voc√™ pode acess√°-los no lado do cliente (se aplic√°vel).</li>
  <li>Quais s√£o os riscos de seguran√ßa associados ao armazenamento de informa√ß√µes sens√≠veis em cookies e como voc√™ pode mitigar esses riscos?</li>
  <li>Descreva como voc√™ usaria <code>hooks.server.js</code> para implementar um sistema simples de autentica√ß√£o baseado em cookies no SvelteKit.</li>
  <li>Qual a import√¢ncia de validar e sanitizar os dados antes de armazen√°-los em cookies?</li>
  <li>Explique a diferen√ßa entre <code>maxAge</code> e <code>expires</code> ao definir um cookie.</li>
  <li>Por que √© importante usar o atributo <code>secure: true</code> em produ√ß√£o?</li>
</ol>

<h3>Exerc√≠cios Pr√°ticos</h3>
<ol class="excs">
  <li><strong>Contador de Visitas:</strong> Implemente um contador de visitas que rastreie quantas vezes um usu√°rio visitou uma p√°gina e armazene esse n√∫mero em um cookie. Exiba o n√∫mero de visitas na p√°gina.</li>
  <li><strong>Banner de Consentimento:</strong> Crie um banner de consentimento de cookies que apare√ßa na primeira visita do usu√°rio ao site. Se o usu√°rio concordar, defina um cookie para n√£o mostrar o banner novamente.</li>
  <li><strong>Autentica√ß√£o Simples:</strong> Implemente um sistema de autentica√ß√£o simples onde os usu√°rios podem inserir um nome de usu√°rio e senha (sem valida√ß√£o real). Se as credenciais forem "corretas" (voc√™ define quais s√£o), defina um cookie para marcar o usu√°rio como autenticado e redirecione-o para uma p√°gina protegida.</li>
  <li><strong>Carrinho de Compras:</strong> Crie uma p√°gina de produto com um bot√£o "Adicionar ao Carrinho". Ao clicar, armazene o ID do produto em um cookie. Em outra p√°gina (carrinho), leia os IDs dos produtos do cookie e exiba uma lista dos itens no carrinho.</li>
  <li><strong>Redirecionamento Condicional:</strong> Crie um hook (<code>hooks.server.js</code>) que verifique a exist√™ncia de um cookie espec√≠fico. Se o cookie n√£o existir, redirecione o usu√°rio para uma p√°gina de boas-vindas/tutorial.</li>
  <li><strong>Teste A/B:</strong> Implemente um teste A/B simples onde diferentes usu√°rios veem diferentes vers√µes de um elemento da p√°gina (por exemplo, um bot√£o com cores diferentes). Use cookies para garantir que cada usu√°rio veja consistentemente a mesma vers√£o.</li>
  <li><strong>Prefer√™ncias de Idioma:</strong> Permita que os usu√°rios escolham um idioma preferido e armazene a prefer√™ncia em um cookie. Use o cookie para exibir o conte√∫do do site no idioma escolhido.</li>
  <li><strong>Lembre-se de mim:</strong> Implemente uma funcionalidade "Lembre-se de mim" que permita aos usu√°rios permanecerem logados mesmo ap√≥s fechar o navegador. Utilize cookies para armazenar um token de autentica√ß√£o (n√£o armazene a senha diretamente!).</li>
</ol>