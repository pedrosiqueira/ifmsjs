<!DOCTYPE html>

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script src="https://unpkg.com/highlightjs-svelte/dist/svelte.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlightjs-line-numbers.js/2.9.0/highlightjs-line-numbers.min.js"></script>
  <script defer>hljs.configure({ languages: ["svelte"] }); hljs.highlightAll(); hljs.initLineNumbersOnLoad();</script>

  <!-- https://github.com/arronhunt/highlightjs-copy -->
  <link rel="stylesheet" href="https://unpkg.com/highlightjs-copy/dist/highlightjs-copy.min.css" />
  <script src="https://unpkg.com/highlightjs-copy/dist/highlightjs-copy.min.js"></script>
  <script defer>hljs.addPlugin(new CopyButtonPlugin());</script>

  <!-- https://github.com/TRSasasusu/highlightjs-highlight-lines.js -->
  <!-- <script src="https://cdn.jsdelivr.net/gh/TRSasasusu/highlightjs-highlight-lines.js@1.2.0/highlightjs-highlight-lines.min.js"></script>
  <script defer>hljs.highlightLinesAll([[], [], [{ start: 2, end: 2, color: 'lightblue' }]]);</script> -->

  <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous" onload="renderMathInElement(document.body,{delimiters:[{left: '$$', right: '$$', display: true},{left: '$', right: '$', display: false}]});"></script> -->

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/pedrosiqueira/custom-style/custom.min.css">
  <script src="https://cdn.jsdelivr.net/gh/pedrosiqueira/custom-style/custom.min.js"></script>
</head>

<h1>Cookies com SvelteKit</h1>

<h2 id="gerenciamento-estado">Gerenciamento de Estado na Web</h2>
<p>Antes de entrarmos no assunto de cookies, vamos entender primeiramente o contexto em que eles foram inventados e por que s√£o necess√°rios.</p>
<p>A comunica√ß√£o entre sistemas frequentemente se desenrola em v√°rias etapas. Conforme essa comunica√ß√£o avan√ßa, o "estado" da intera√ß√£o muda. Podemos definir o "estado" da comunica√ß√£o como "o conjunto de informa√ß√µes que descreve o contexto atual de uma intera√ß√£o entre cliente e servidor". Em outras palavras: o estado representa a identidade do usu√°rio, suas a√ß√µes pr√©vias, o est√°gio atual da intera√ß√£o ou qualquer outro dado que o servidor precise lembrar entre requisi√ß√µes. Isto posto, um sistema pode ser classificado como stateless ou stateful.</p>

<h3 id="stateless">‚úÖ Stateless (Sem Estado)</h3>
<p>Um sistema <strong>stateless</strong> n√£o ret√©m informa√ß√µes sobre intera√ß√µes anteriores. Cada requisi√ß√£o √© tratada de forma <strong>independente</strong>, como se fosse a <strong>primeira intera√ß√£o</strong> entre o cliente e o servidor.</p>
<p>Exemplo: O protocolo HTTP puro √© stateless. Em cada requisi√ß√£o, o servidor n√£o reconhece o cliente, a menos que a requisi√ß√£o inclua um identificador (token, cookie, etc.).</p>

<h3 id="stateful">üîÅ Stateful (Com Estado)</h3>
<p>Um sistema <strong>stateful</strong> <strong>mant√©m informa√ß√µes</strong> sobre intera√ß√µes passadas. O servidor <strong>lembra do cliente</strong> entre requisi√ß√µes, geralmente armazenando esses dados em uma <strong>sess√£o</strong>.</p>
<p>Exemplo: Ap√≥s o login em um site, o servidor armazena os dados do usu√°rio em uma sess√£o, permitindo que ele permane√ßa autenticado enquanto navega pelas p√°ginas.</p>

<h3 id="comparacao-estado">üìä Compara√ß√£o</h3>
<table border>
  <thead>
    <tr>
      <th>Caracter√≠stica</th>
      <th>Stateless</th>
      <th>Stateful</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Mant√©m estado?</td>
      <td>‚ùå N√£o</td>
      <td>‚úÖ Sim</td>
    </tr>
    <tr>
      <td>Complexidade no servidor</td>
      <td>‚úÖ Baixa</td>
      <td>üî∫ Alta</td>
    </tr>
    <tr>
      <td>Escalabilidade</td>
      <td>‚úÖ Alta (sem estado para gerenciar)</td>
      <td>üîª Menor (estado precisa ser compartilhado entre servidores ou persistido)</td>
    </tr>
    <tr>
      <td>Exemplos</td>
      <td>APIs REST, HTTP puro</td>
      <td>Sites com login, WebSockets</td>
    </tr>
    <tr>
      <td>Requisi√ß√µes independentes?</td>
      <td>‚úÖ Sim</td>
      <td>‚ùå N√£o</td>
    </tr>
    <tr>
      <td>Armazenamento de sess√£o</td>
      <td>‚ùå Cliente envia tudo o que √© necess√°rio</td>
      <td>‚úÖ Servidor armazena dados da sess√£o</td>
    </tr>
  </tbody>
</table>

<hr />

<h2 id="o-que-sao-cookies">üç™ O que s√£o Cookies?</h2>
<p><strong>Cookies</strong> s√£o pequenos arquivos de texto que os navegadores armazenam localmente no dispositivo do usu√°rio a pedido de um servidor web. Eles servem para guardar informa√ß√µes √∫teis entre diferentes requisi√ß√µes HTTP, que, por padr√£o, s√£o <em>stateless</em> (sem estado).</p>
<p>Ou seja, sem cookies (ou outros mecanismos de armazenamento), cada requisi√ß√£o seria tratada como se fosse feita por um visitante completamente novo.</p>

<h3 id="para-que-servem">üß† Para que servem?</h3>
<p>Cookies podem ser usados para diversas finalidades, incluindo:</p>
<ul>
  <li><strong>Autentica√ß√£o</strong>: manter o usu√°rio logado.</li>
  <li><strong>Prefer√™ncias</strong>: tema, idioma, layout do site.</li>
  <li><strong>Carrinho de compras</strong>: persist√™ncia dos itens selecionados.</li>
  <li><strong>An√°lise de dados (Analytics)</strong>: rastrear o comportamento do usu√°rio para fins estat√≠sticos.</li>
  <li><strong>Personaliza√ß√£o</strong>: exibir conte√∫dos personalizados com base no perfil do usu√°rio (marketing).</li>
</ul>

<h3 id="como-funcionam">üõ† Como funcionam?</h3>

<p>O servidor envia um cookie para o navegador usando o cabe√ßalho HTTP <code>Set-Cookie</code>. Exemplo:</p>
<pre><code>Set-Cookie: sessionId=abc123; HttpOnly; Path=/; Max-Age=3600</code></pre>
<p>Esse cookie ser√° armazenado pelo navegador e inclu√≠do automaticamente em cada requisi√ß√£o subsequente ao mesmo dom√≠nio (ou caminho correspondente).</p>
<h3 id="envio-pelo-navegador">2. Envio pelo navegador</h3>
<p>Sempre que o navegador fizer uma nova requisi√ß√£o ao servidor, ele incluir√° todos os cookies v√°lidos no cabe√ßalho <code>Cookie</code>:</p>
<pre><code>Cookie: sessionId=abc123</code></pre>

<h3 id="atributos-cookie">üîê Atributos importantes de um cookie</h3>
<table border>
  <thead>
    <tr>
      <th>Atributo</th>
      <th>Descri√ß√£o</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>Name=Value</code></td>
      <td>Nome e valor do cookie. Obrigat√≥rio.</td>
    </tr>
    <tr>
      <td><code>Path</code></td>
      <td>Define em qual caminho o cookie √© enviado. Ex: <code>/</code>, <code>/admin</code>.</td>
    </tr>
    <tr>
      <td><code>Domain</code></td>
      <td>Restringe o cookie a um subdom√≠nio (ex: <code>.meusite.com</code>).</td>
    </tr>
    <tr>
      <td><code>Expires</code></td>
      <td>Data e hora em que o cookie expira.</td>
    </tr>
    <tr>
      <td><code>Max-Age</code></td>
      <td>Tempo de vida em segundos (prefer√≠vel em vez de <code>Expires</code>).</td>
    </tr>
    <tr>
      <td><code>HttpOnly</code></td>
      <td>Impede o acesso via JavaScript, aumentando a seguran√ßa contra ataques XSS (Cross-Site Scripting).</td>
    </tr>
    <tr>
      <td><code>Secure</code></td>
      <td>Garante que o cookie seja enviado apenas em conex√µes HTTPS (seguras).</td>
    </tr>
    <tr>
      <td><code>SameSite</code></td>
      <td>Controla o envio do cookie em requisi√ß√µes cross-site, protegendo contra ataques CSRF (Cross-Site Request Forgery). Pode ser <code>Strict</code>, <code>Lax</code> ou <code>None</code>.</td>
    </tr>
  </tbody>
</table>

<div class="info">
  <p>Dica: Use as ferramentas de desenvolvedor do seu navegador (geralmente acess√≠veis pelo menu "Mais ferramentas" ou clicando com o bot√£o direito na p√°gina e selecionando "Inspecionar") para visualizar os cookies de qualquer p√°gina web!</p>
</div>

<h3 id="tipos-de-cookies">üí° Tipos de Cookies</h3>
<p>Podemos classificar os cookies com base na sua durabilidade:</p>
<table border>
  <thead>
    <tr>
      <th>Tipo</th>
      <th>Dura√ß√£o</th>
      <th>Uso Comum</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>De Sess√£o</strong></td>
      <td>At√© o fechamento do navegador</td>
      <td>Login tempor√°rio, carrinhos de compras para usu√°rios n√£o registrados, manter prefer√™ncias durante uma sess√£o an√¥nima.</td>
    </tr>
    <tr>
      <td><strong>Persistentes</strong></td>
      <td>At√© a data de expira√ß√£o definida (<code>Max-Age</code> ou <code>Expires</code>)</td>
      <td>Funcionalidade "Lembrar de mim" em logins, prefer√™ncias de tema e idioma, itens salvos no carrinho de compras entre visitas.</td>
    </tr>
  </tbody>
</table>

<p>Tamb√©m podemos classificar os cookies com base no dom√≠nio que os define:</p>

<table border>
  <thead>
    <tr>
      <th>Tipo</th>
      <th>Descri√ß√£o</th>
      <th>Uso Comum</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>Pr√≥prios (First-party)</strong></td>
      <td>Cookies definidos pelo pr√≥prio site que voc√™ est√° visitando.</td>
      <td>Melhorar a experi√™ncia do usu√°rio, coletar dados anal√≠ticos sobre o comportamento do usu√°rio no site, lembrar configura√ß√µes de idioma ou outras prefer√™ncias.</td>
    </tr>
    <tr>
      <td><strong>De Terceiros (Third-party)</strong></td>
      <td>Cookies definidos por um dom√≠nio diferente do site que voc√™ est√° visitando (geralmente por anunciantes, redes sociais ou outros servi√ßos externos).</td>
      <td>Rastreamento do usu√°rio em diferentes sites para fins de publicidade direcionada, exibir an√∫ncios personalizados com base nos seus interesses, integrar funcionalidades de redes sociais (como bot√µes de "curtir" ou "compartilhar").</td>
    </tr>
  </tbody>
</table>

<h3 id="seguranca">‚ö†Ô∏è Boas Pr√°ticas de Seguran√ßa</h3>
<ol>
  <li><strong>HttpOnly</strong>: Protege contra ataques XSS, impedindo que scripts JavaScript acessem o cookie.</li>
  <li><strong>Secure</strong>: Garante que o cookie seja transmitido apenas por conex√µes HTTPS (criptografadas), evitando intercepta√ß√£o por terceiros.</li>
  <li><strong>SameSite</strong>: Controla quando o cookie √© enviado em requisi√ß√µes cross-site, mitigando o risco de ataques CSRF.
    <ul>
      <li><code>Strict</code>: O cookie s√≥ √© enviado em requisi√ß√µes originadas do mesmo site. Oferece a maior prote√ß√£o contra CSRF, mas pode afetar a usabilidade em alguns cen√°rios (ex: links externos).</li>
      <li><code>Lax</code>: Permite o envio do cookie em algumas requisi√ß√µes cross-site "seguras", como ao clicar em links (m√©todo GET). Oferece um bom equil√≠brio entre seguran√ßa e usabilidade.</li>
      <li><code>None</code>: Permite o envio do cookie em todas as requisi√ß√µes cross-site. Requer que o atributo <code>Secure</code> tamb√©m seja definido, garantindo que o cookie seja transmitido apenas por HTTPS.</li>
    </ul>
  </li>
  <li><strong>Cookies n√£o s√£o criptografados por padr√£o</strong>. Se voc√™ precisar armazenar dados sens√≠veis, √© essencial criptograf√°-los antes de armazenar no cookie.</li>
</ol>

<h3>Como os cookies afetam a privacidade?</h3>
<p>Adaptado <a href="https://www.geeksforgeeks.org/understanding-cookies-in-web-browsers/">daqui</a> </p>
<p>Os cookies podem ter efeitos tanto positivos quanto negativos na privacidade:</p>

<p>Positivo: Cookies podem melhorar a experi√™ncia do usu√°rio, lembrando prefer√™ncias e informa√ß√µes de login, tornando os sites mais f√°ceis de usar.</p>

<p>Negativo: Cookies podem levantar preocupa√ß√µes com a privacidade quando s√£o usados para rastreamento e cria√ß√£o de perfis sem o consentimento do usu√°rio. O rastreamento excessivo pode resultar em perda de privacidade online e potencial uso indevido de dados.</p>

<h3 id="alternativas">üì¶ Cookies vs Alternativas</h3>
<p>Al√©m dos cookies, existem outras formas de armazenamento no navegador:</p>
<table border>
  <thead>
    <tr>
      <th>Tecnologia</th>
      <th>Vis√≠vel no JS?</th>
      <th>Expira?</th>
      <th>Envio autom√°tico ao servidor?</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Cookies</td>
      <td>Sim (se n√£o for HttpOnly)</td>
      <td>Sim</td>
      <td>Sim</td>
    </tr>
    <tr>
      <td>localStorage</td>
      <td>Sim</td>
      <td>N√£o</td>
      <td>N√£o</td>
    </tr>
    <tr>
      <td>sessionStorage</td>
      <td>Sim</td>
      <td>Ao fechar a aba</td>
      <td>N√£o</td>
    </tr>
    <tr>
      <td>IndexedDB</td>
      <td>Sim</td>
      <td>N√£o</td>
      <td>N√£o</td>
    </tr>
  </tbody>
</table>
<p>Use cookies quando voc√™ <strong>precisar que o servidor tenha acesso aos dados</strong> em cada requisi√ß√£o. Para outros casos, utilize <code>localStorage</code> ou <code>sessionStorage</code>.</p>

<h3 id="conclus√£o">‚úÖ Conclus√£o</h3>
<p>Cookies s√£o essenciais para adicionar "mem√≥ria" aos aplicativos web. Quando utilizados corretamente, eles permitem autentica√ß√£o, personaliza√ß√£o e muito mais. No entanto, seu uso deve ser feito com cautela, respeitando as boas pr√°ticas de seguran√ßa (como <code>HttpOnly</code>, <code>Secure</code> e <code>SameSite</code>) e a privacidade do usu√°rio.</p>
<hr />

<h2 id="cookies-no-sveltekit">üçÉ Cookies no SvelteKit</h2>
<p>No SvelteKit, use <code>event.cookies</code> em <code>+page.server.js</code>, <code>+layout.server.js</code> ou <code>hooks.server.js</code>:</p>

<h3>Leitura</h3>
<pre><code class="js">export const load = async ({ cookies }) =&gt; {
  const theme = cookies.get('theme') || 'light';
  return { theme };
};</code></pre>

<h3>Grava√ß√£o</h3>
<pre><code class="js">export const actions = {
  setTheme: async ({ request, cookies }) =&gt; {
    const data = await request.formData();
    const theme = data.get('theme');
    cookies.set('theme', theme, {
      path: '/',
      maxAge: 60 * 60 * 24 * 30 // 30 dias
    });
  }
};</code></pre>

<h3>Remo√ß√£o</h3>
<pre><code class="js">cookies.delete('theme', { path: '/' });</code></pre>