<!DOCTYPE html>

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script src="https://unpkg.com/highlightjs-svelte/dist/svelte.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlightjs-line-numbers.js/2.9.0/highlightjs-line-numbers.min.js"></script>
  <script defer>hljs.configure({ languages: ["svelte"] }); hljs.highlightAll(); hljs.initLineNumbersOnLoad();</script>

  <!-- https://github.com/arronhunt/highlightjs-copy -->
  <link rel="stylesheet" href="https://unpkg.com/highlightjs-copy/dist/highlightjs-copy.min.css" />
  <script src="https://unpkg.com/highlightjs-copy/dist/highlightjs-copy.min.js"></script>
  <script defer>hljs.addPlugin(new CopyButtonPlugin());</script>

  <!-- https://github.com/TRSasasusu/highlightjs-highlight-lines.js -->
  <!-- <script src="https://cdn.jsdelivr.net/gh/TRSasasusu/highlightjs-highlight-lines.js@1.2.0/highlightjs-highlight-lines.min.js"></script>
  <script defer>hljs.highlightLinesAll([[], [], [], [], [], [], [{ start: 1, end: 1, color: 'lightblue' }, { start: 7, end: 8, color: 'lightgreen' }, { start: 9, end: 13, color: 'lightblue' }]]);</script> -->

  <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous" onload="renderMathInElement(document.body,{delimiters:[{left: '$$', right: '$$', display: true},{left: '$', right: '$', display: false}]});"></script> -->

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/pedrosiqueira/custom-style/custom.min.css">
  <script src="https://cdn.jsdelivr.net/gh/pedrosiqueira/custom-style/custom.min.js"></script>
</head>

<h1>Caso de uso: usando Ações de Formulário como exemplo para a lógica de autenticação [ou um título melhor]</h1>
<h2>Introdução</h2>
[texto introdutório]

<h2>O banco de dados</h2>
[texto introdutório]

<p>Crie o arquivo <code ctc>src/lib/server/usersDatabase.js</code>:</p>
<pre><code>const usersData = new Map();
const sessionsData = new Map();
const sessionTimeout = 1000 * 60 * 60; // 1 hour

export const usersDB = {
  create: (email, password) => {
    if (usersData.has(email)) throw new Error('Email já cadastrado');

    if (email == 'email@proibido') throw new Error('Email proibido');

    usersData.set(email, { email, password });
  },
  read: (email) => {
    return usersData.get(email);
  }
};

export const sessionsDB = {
  create: (user) => {
    const session = { user, expires: Date.now() + sessionTimeout };
    const sessionId = crypto.randomUUID();
    sessionsData.set(sessionId, session);
    return sessionId;
  },
  read: (sessionId) => {
    const session = sessionsData.get(sessionId);
    if (!session) return null;

    if (Date.now() > session.expires) {
      sessionsData.delete(sessionId);
      return null;
    }

    return session.user;
  },
  delete: (sessionId) => {
    sessionsData.delete(sessionId);
  }
};</code></pre>

<p>Explicação:</p>
<ul>
  <li>Esse arquivo representa nosso banco de dados de usuários. No momento, as duas únicas operações disponíveis são <code>create</code> e <code>read</code>.</li>
  <li>Linha 5: A função <code>create(email, password)</code> adiciona um novo usuário ao banco.</li>
  <li>Linha 6: Se já houver um usuário com o mesmo email, um erro é lançado.</li>
  <li>Linha 8: Um pequeno easter egg para forçar um erro de servidor em um teste futuro.</li>
  <li>Linha 10: Armazena o novo usuário no mapa <code>users</code>.</li>
  <li>Linha 13: A função <code>read(email)</code> retorna o usuário correspondente ou <code>undefined</code> caso não exista.</li>
</ul>
<div class="info">Atenção: Esse é um banco de dados apenas para fins didáticos! Em um sistema real, os dados devem ser armazenados em um banco de dados apropriado. E o mais importante: AS SENHAS NUNCA DEVEM SER SALVAS EM TEXTO PURO!!!</div>

<h2 id="Named-actions">[um título para essa seção]</h2>
[texto introdutório]
<p>Crie o arquivo <code ctc>src/routes/04/login/+page.server.js</code>:</p>

<pre><code>import { fail, redirect } from '@sveltejs/kit';
import * as users from '$lib/server/usersDatabase.js';

export const actions = {
  login: async ({ request }) => {
    const data = await request.formData();
    const email = data.get('email');
    const password = data.get('password');

    if (!email || !password) return fail(400, { error: 'Email e senha são obrigatórios.', email });

    const user = users.read(email);

    if (!user) return fail(400, { error: 'Usuário não encontrado.', email });

    if (user.password != password) return fail(400, { error: 'Senha incorreta.', email });

    redirect(303, '/04/dashboard');
  },

  register: async ({ request }) => {
    const data = await request.formData();
    const email = data.get('email');
    const password = data.get('password');

    if (!email || !password) return fail(400, { error: 'Email e senha são obrigatórios.', email });

    if (!email.includes('@')) return fail(400, { error: 'Email inválido.', email });

    if (password.length < 4) return fail(400, { error: 'A senha deve ter pelo menos 4 caracteres.', email });

    if (users.read(email)) return fail(400, { error: 'Email já cadastrado.', email });

    try {
      users.create(email, password);
      return { success: true, msg: 'Usuário registrado com sucesso! Agora você pode fazer o login...' };
    } catch (error) {
      console.error('Erro ao registrar usuário:', error);
      return fail(500, { error: 'Ocorreu um erro inesperado. Tente novamente mais tarde.', email });
    }
  }
};</code></pre>

<p>Crie o arquivo <code ctc>src/routes/04/login/+page.svelte</code>:</p>

<pre><code>&lt;script&gt;
  let { form } = $props();
&lt;/script&gt;

&lt;h1&gt;Entrada / Registro&lt;/h1&gt;

&lt;form method="POST" action="?/login"&gt;
  &lt;label&gt;Email &lt;input name="email" type="email" value={form?.email || ''} required /&gt;&lt;/label&gt;
  &lt;label&gt;Senha &lt;input name="password" type="password" required /&gt;&lt;/label&gt;
  &lt;button&gt;Entrar&lt;/button&gt;
  &lt;button formaction="?/register"&gt;Registrar&lt;/button&gt;
&lt;/form&gt;

{#if form?.error}
  &lt;div class="d-inline-flex mt-3 alert alert-danger alert-dismissible fade show"&gt;
    {form?.error}
    &lt;button class="btn-close" data-bs-dismiss="alert" aria-label="Close"&gt;&lt;/button&gt;
  &lt;/div&gt;
{/if}

{#if form?.success}
  &lt;div class="d-inline-flex mt-3 alert alert-success alert-dismissible fade show"&gt;
    {form?.msg || 'Sucesso!'}
    &lt;button class="btn-close" data-bs-dismiss="alert" aria-label="Close"&gt;&lt;/button&gt;
  &lt;/div&gt;
{/if}</code></pre>

<p>Explicação:</p>
<ul>
  <li>Linha 2: A propriedade <code>form</code> contém os dados retornados pela ação de formulário.</li>
  <li>Linha 14: Se a ação retornou <code>success</code>, exibimos a mensagem correspondente.</li>
  <li>Linha 15: As classes <code>alert alert-success alert-dismissible fade show</code> definem o estilo da <a target="_blank" href="https://getbootstrap.com/docs/5.3/components/alerts/#dismissing">caixa de alerta</a> do Bootstrap. <code>d-inline-flex</code> faz com que ela ocupe apenas o espaço necessário.</li>
  <li>Linha 16: Mostra a mensagem retornada ou, se ausente, "Sucesso!".</li>
  <li>Linha 17: Exatamente como está na <a target="_blank" href="https://getbootstrap.com/docs/5.3/components/alerts/#dismissing">documentação do Bootstrap</a>.</li>
</ul>

<h2>Validação de erros</h2>

<p>Explicação:</p>
<ul>
  <li>Linhas 13–19: Validamos os dados. Se estiverem inválidos, usamos <code>fail</code> para retornar a mensagem de erro e manter os dados do formulário.</li>
  <li>Linha 15: A validação de email é simplificada. Em sistemas reais, utilize bibliotecas específicas e robustas para isso.</li>
  <li>Linha 19: Impede que um email já registrado seja reutilizado.</li>
  <li>Linha 24: Como <code>users.create</code> pode lançar erros, registramos o erro no terminal e exibimos uma mensagem genérica ao usuário.</li>
  <div class="info">Recomendação: Não é boa prática exibir mensagens de erro técnicas diretamente ao usuário. Elas são úteis apenas para desenvolvedores e podem revelar informações sensíveis. Por isso, erros de servidor (categoria 500) devem ser registrados apenas no servidor, onde podem ser acessados por quem mantém o sistema.</div>
</ul>

<p>O tratamento de mensagens de erro no arquivo <code ctc>src/routes/04/login/+page.svelte</code>:</p>
<p>Explicação:</p>
<ul>
  <li>Linha 8: O valor do campo email é mantido em caso de erro, para facilitar a correção por parte do usuário.</li>
  <li>Linha 9: Por segurança, a senha não é mantida após erro.</li>
  <li>Linhas 14–19: Se houver erro, mostramos uma caixa de alerta vermelha com a mensagem apropriada.</li>
  <li>A validação no navegador (como <code>type="email"</code> e <code>required</code>) ajuda a evitar erros, mas a validação no servidor é indispensável, pois o código do cliente pode ser alterado pelo usuário. Para testar, inspecione o campo de e-mail, remova o atributo <code>type="email"</code> e tente enviar um endereço de e-mail inválido.</li>
  <li>Agora é a hora, teste o easter egg!</li>
</ul>

<h2>Redirecionamentos</h2>
<p> a lógica de login no arquivo <code ctc>src/routes/04/login/+page.server.js</code>:</p>
<p>Explicação:</p>
<ul>
  <li><strong>Linha 1:</strong> Importamos a função <code>redirect</code>, necessária para realizar o redirecionamento.</li>
  <li><strong>Linhas 6–8:</strong> Coletamos os dados do formulário enviado.</li>
  <li><strong>Linhas 10, 14 e 16:</strong> Realizamos validações nos dados.</li>
  <li><strong>Linha 12:</strong> Buscamos o usuário no "banco de dados".</li>
  <li id="dashboard"><strong>Linha 18:</strong> Se o login for bem-sucedido, redirecionamos o usuário para <code>/04/dashboard</code> com o código HTTP 303. Essa página ainda não foi criada — fica como tarefa para você implementá-la.</li>
</ul>

<h2>Conclusão</h2>
<p>Esta foi uma introdução à lógica de autenticação com formulários e redirecionamentos no SvelteKit. Ainda há muitos aspectos importantes que não abordamos — como o uso de cookies, armazenamento de sessões, proteção de rotas e logout seguro. Esses tópicos serão tratados em lições futuras. Por enquanto, concentre-se em entender bem a comunicação entre cliente e servidor.</p>

<h2>Exercícios</h2>
<ol class="excs">
  <li>Crie a página <a href="#dashboard"><code>/04/dashboard</code></a> e exiba nela uma mensagem personalizada, como: <code>“Bem-vindo(a), [email]!”</code>, utilizando o email do usuário autenticado.</li>
  <li><strong>CRUD completo de produtos</strong>
    <p>Crie as seguintes rotas:</p>
    <ul>
      <li>
        <strong><code>/04/ex3/produtos/novo</code></strong> (Formulário de Criação)
        <ul>
          <li>Formulário com os campos: nome (obrigatório, exclusivo), descrição (opcional, min. 10 caracteres), preço (positivo), quantidade (inteiro ≥ 0)</li>
          <li>Falha: retorna dados e erros.</li>
          <li>Sucesso: redireciona para a Lista de Produtos com uma mensagem de sucesso.</li>
        </ul>
      </li>
      <li>
        <strong><code>/04/ex3/produtos/[id]/editar</code></strong> (Formulário de Edição)
        <ul>
          <li>Carrega os dados do produto via <code>load</code>.</li>
          <li>Mesma validação da criação.</li>
          <li>Falha: retorna dados e erros.</li>
          <li>Sucesso: redireciona para a Lista de Produtos com uma mensagem de sucesso.</li>
        </ul>
      </li>
      <li>
        <strong><code>/04/ex3/produtos</code></strong> (Lista de Produtos)
        <ul>
          <li>Link para o Formulário de Criação.</li>
          <li>Tabela com nome, descrição, preço e quantidade dos produtos.</li>
          <li>Cada item tem um link para o Formulário de Edição do produto.</li>
          <li>Cada item também tem um formulário de exclusão do produto que executa a ação nomeada <code>excluir</code> na mesma rota. Ao excluir, retorna uma mensagem de sucesso.</li>
          <li>Exibe mensagens de sucesso após ações como criação, edição ou exclusão.</li>
        </ul>
      </li>
    </ul>
    <p>Dicas:</p>
    <ul>
      <li>Os dados podem ser armazenados em um array ou mapa local em <code>$lib/server/produtos.js</code> com funções <code>create</code>, <code>read</code>, <code>update</code> e <code>delete</code>, simulando um banco de dados.</li>
      <li>Para simplificação, use um contador incremental para IDs.</li>
      <li>As mensagens de sucesso nos redirecionamentos podem ser passadas via parâmetros de consulta e obtidas com <code>URLSearchParams</code>.</li>
    </ul>
  </li>
  <li><strong>Não se esqueça de estilizar as páginas!</strong></li>
</ol>